# 一键宏功能修复说明

## 问题现象
一键宏功能需要**连续按两次快捷键**才能生效。

## 问题原因
原神6.0版本引入的草露进度条会导致右侧队伍UI位置偏移，系统的UI偏移检测逻辑不够稳定，可能导致：
- 第一次按快捷键时，检测到错误的UI偏移状态
- 使用错误的位置判断当前出战角色，识别到错误的角色
- 如果该角色的宏配置为空，则不执行
- 第二次按快捷键时才正确识别并执行

## 修复方案
在当前角色识别逻辑中增加**自动重试机制**：
1. 如果初始的偏移状态导致识别异常，自动切换偏移状态并重试
2. 如果切换后识别成功，保持新的偏移状态
3. 如果仍然失败，恢复原状态

## 修复效果
✅ **第一次按快捷键即可正确执行宏**，无需按两次

## 修改文件
- `BetterGenshinImpact/GameTask/AutoFight/Model/CombatScenes.cs`
  - 增强 `CurrentAvatar()` 方法：添加自动重试逻辑
  - 新增 `ToggleIndexRectOffset()` 方法：用于切换UI偏移状态

## 日志参考

### ✅ 自动修正成功
```log
[WRN] 当前角色识别异常（检测到0个出战角色，预期1个），尝试切换UI偏移状态重试
[INF] 切换UI偏移状态成功！偏移状态: 正常 -> 上偏移，识别到当前角色: 玛薇卡
[INF] → "玛薇卡"执行宏
```

### ❌ 自动修正失败（需进一步排查）
```log
[WRN] 当前角色识别异常（检测到0个出战角色，预期1个），尝试切换UI偏移状态重试
[WRN] 切换UI偏移状态后仍无法正确识别（检测到0个出战角色），恢复原状态
[ERR] 无法识别出战角色
```

如果遇到第二种情况，可能需要进一步优化UI偏移检测算法。
